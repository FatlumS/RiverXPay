<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - RiverXPay</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 40px auto; padding: 20px; }
        .card { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .btn { background: #2a7ae2; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        form { margin-bottom: 20px; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <h1>RiverXPay Dashboard</h1>
    <p>Welcome, <strong><%= shopDomain %></strong>! | <a href="/">Home</a></p>

    <div class="card">
        <h2>Create a Test Charge</h2>
        <form id="chargeForm">
            <input type="text" name="orderId" placeholder="Order ID (e.g., 1001)" required>
            <input type="number" name="amount" placeholder="Amount (USD)" step="0.01" min="0.01" required>
            <input type="hidden" name="shopDomain" value="<%= shopDomain %>">
            <button type="submit" class="btn">Create Payment Link</button>
        </form>
    </div>

    <div class="card">
        <h2>Analytics</h2>
        <p><strong>Total Revenue:</strong> $<%= totalRevenue %></p>
        <p><strong>Total Fees Earned:</strong> $<%= totalFees %></p>
    </div>

    <div class="card">
        <h2>Recent Charges</h2>
        <% if (charges.length > 0) { %>
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Amount</th>
                        <th>Fee</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    <% charges.forEach(function(charge) { %>
                        <tr>
                            <td><%= charge.orderId %></td>
                            <td>$<%= charge.amount.toFixed(2) %></td>
                            <td>$<%= charge.fee.toFixed(2) %></td>
                            <td><%= charge.timestamp.toLocaleDateString() %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        <% } else { %>
            <p>No charges found.</p>
        <% } %>
    </div>

    <script>
        // Handle the form submission to create a charge via AJAX
        document.getElementById('chargeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/create-charge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    // Redirect the user to the Coinbase checkout page
                    window.location.href = result.checkout_url;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to create charge. Check console for details.');
            }
        });
    </script>
</body>
</html>
